{% extends 'baseadmin.html' %}
{% load color_filters %}

{% block content %}

{% block style %}

.colorfield {
    width: 80px; /* Adjust the width as needed */
}


{% endblock %}

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>Create Product</h1>
      <nav>
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Home</a></li>
          <li class="breadcrumb-item">Products</li>
          <li class="breadcrumb-item"><a href="{% url 'admin_product' %}">Product info</a></li>
          <li class="breadcrumb-item active">Create Product Variant</li>
        </ol>
      </nav>
    </div><!-- End Page Title -->

    <section class="section" >
        
            <h1>{{ product.name }} Details</h1>
            <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addParentVariantModal">
                Add Parent Variant
            </button>
    
            <div id="accordion">
                {% for parent_variant in parent_variants %}
                <div class="card">
                    <div id="heading{{ parent_variant.id }}" class="card-header" data-toggle="collapse" data-target="#collapse{{ parent_variant.id }}" aria-expanded="true" aria-controls="collapse{{ parent_variant.id }}">
                        <h5 class="mb-0">
                            <div class="row">
                                <div class="col-6">
                                    <div class="row" >
                                        <div class="col-6">
                                    <i class="bi bi-square-fill" style="color: {{ parent_variant.color }};"></i>
                                </div>
                                <div class="col-6">
                                     <h2><strong>{{ parent_variant.inventory_parent.color }}</strong></h2>
                                    </div>
                            </div>
                            </div>
                                <div class="col-6">
                                  {% if parent_variant.main_image.url %}
                                    <img src="{{ parent_variant.main_image.url }}" width="50px" alt="{{ parent_variant.color }}">
                                    <a href="#" class="" data-toggle="modal" data-target="#editImagesModal-{{ parent_variant.id }}"><i class="bi bi-pencil-square"></i></a>
                                   {% else %}
                                       <!-- Button trigger modal -->
                                                            <a href="#" class="" data-toggle="modal" data-target="#addImagesModal-{{parent_variant.id}}">
                                                                <i class="bi bi-plus-circle-fill fs-2"></i>
                                                            </a>
                                                            <!-- Add Images Modal -->
                                                            <div class="modal fade" id="addImagesModal-{{parent_variant.id}}" tabindex="-1" role="dialog" aria-labelledby="addImagesModalLabel" aria-hidden="true">
                                                                <div class="modal-dialog" role="document">
                                                                    <div class="modal-content">
                                                                        <div class="modal-header">
                                                                            <h5 class="modal-title" id="addImagesModalLabel">Add Images</h5>
                                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                                <span aria-hidden="true">&times;</span>
                                                                            </button>
                                                                        </div>
                                                                    
                                                                        <div class="modal-body">
                                                                            <h4>{{pv.product.id}}</h4>
                                                                            <form method="post" action="{% url 'add_productimage' %}" enctype="multipart/form-data">
                                                                                {% csrf_token %}
                                                                                
                                                                        
                                                                                <div class="input-group mb-3">
                                                                                    <label for="imageInput1{{pv.id}}" class="btn btn-primary rounded-circle" data-toggle="tooltip" title="Add Image 1">
                                                                                        <i class="material-icons">&#xE145;</i>
                                                                                    </label>
                                                                                    <input type="file" id="imageInput1{{pv.id}}" name="image{{pv.id}}1" accept="image/*" style="display: none;">
                                                                                </div>
                                                                        
                                                                                <div class="input-group mb-3">
                                                                                    <label for="imageInput2{{pv.id}}" class="btn btn-primary rounded-circle" data-toggle="tooltip" title="Add Image 2">
                                                                                        <i class="material-icons">&#xE145;</i>
                                                                                    </label>
                                                                                    <input type="file" id="imageInput2{{pv.id}}" name="image{{pv.id}}2" accept="image/*" style="display: none;">
                                                                                </div>
                                                                        
                                                                                <div class="input-group mb-3">
                                                                                    <label for="imageInput3{{pv.id}}" class="btn btn-primary rounded-circle" data-toggle="tooltip" title="Add Image 3">
                                                                                        <i class="material-icons">&#xE145;</i>
                                                                                    </label>
                                                                                    <input type="file" id="imageInput3{{pv.id}}" name="image{{pv.id}}3" accept="image/*" style="display: none;">
                                                                                </div>
                                                                                    <input type="text" value="{{ pv.id }}" name="product_id" hidden>
                                                                        
                                                                                <div class="modal-footer">
                                                                                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                                                                    <button type="submit" class="btn btn-primary">Submit</button>
                                                                                </div>
                                                                            </form>
                                                                        </div>

                                                                        
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {%endif%}




                                </div>
                            </div>
                            <div class="col-4" >  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editParentVariantModal{{ parent_variant.id }}">
                                Edit Parent Variant
                            </button>   </div>

                            <div class="modal fade" id="editParentVariantModal{{ parent_variant.id }}" tabindex="-1" role="dialog" aria-labelledby="addParentVariantModalLabel" aria-hidden="true">
                                <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                <div class="modal-header">
                                <h5 class="modal-title" id="addParentVariantModalLabel">Edit Parent Variant</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                                </button>
                                </div>
                                <div class="modal-body">
                                <!-- Parent Variant Form -->
                                <form id="addParentVariantForm" action="{% url 'edit_product_parent_variant' %}" method="POST" enctype="multipart/form-data">
                                    {% csrf_token %}
                                
                                    <!-- Color Input for ProductParentVariant -->

                                    <div class="form-group">
                                        <label for="">Selected Color:</label>
                                        <input type="color" name="" value="{{parent_variant.color}}" class="form-control" required>

                                        <label for="color">Color</label>
                                        <input type="color" name="color" class="form-control" required>
                                    </div>
                                    <input type="number" name="pv_id" value="{{parent_variant.id}}" hidden>
                                    <input type="number" name="product_id" value="{{product.id}}" hidden>
                                
                                    <!-- Dropdown for ProductParentVariantInventory colors -->
                                    <div class="form-group">
                                        <label for="inventory_color">Select Color from Inventory</label>
                                        <select name="parent_inventory_id" class="form-control" required>
                                            <option value="" selected disabled>Select Color</option>
                                            {% for inventory_item in product_parent_variant_inventory %}
                                                <option value="{{ inventory_item.id }}" {% if inventory_item.color == parent_variant.inventory_parent.color %} selected {% endif %}>{{ inventory_item.color }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                
                                    <!-- Other fields for ProductParentVariant -->
                                    <!-- <div class="form-group">
                                        <label for="main_image">Main Image</label>
                                        <input type="file" name="main_image" accept="image/*" class="form-control-file">
                                    </div>
                                
                                    <div class="form-group">
                                        <label for="images">Additional Images</label>
                                        <input type="file" name="images" accept="image/*" class="form-control-file" multiple>
                                    </div> -->
                                                <div class="form-group">
                                                    <h6 class="mb-2 pb-1">Status: </h6>
                                
                                            <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="inlineRadioOptionsDefault" 
                                            value="True" {%if parent_variant.default %}checked {% endif %} />
                                            <label class="form-check-label" for="active">True</label>
                                            </div>
                                
                                
                                            <div class="form-check form-check-inline">
                                            <input class="form-check-input" type="radio" name="inlineRadioOptionsDefault"
                                            value="False" />
                                            <label class="form-check-label" for="inactive">False</label>
                                            </div>
                                                </div>
                                
                                    <!-- Add more fields as needed -->
                                
                                    <!-- Submit Button -->
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                        <button type="submit" class="btn btn-primary">Edit Parent Variant</button>
                                    </div>
                                </form>
                                </div>
                                </div>
                                </div>
                                </div>
                                

                                 
                           
                        </h5>
                    </div>
    
                        <div id="collapse{{ parent_variant.id }}" class="collapse" aria-labelledby="heading{{ parent_variant.id }}" data-parent="#accordion">
                            <div class="card-body mt-5">
                                
                                {% for image in parent_variant.images.all %}
                                      <img src="{{ image.image.url }}" alt="Product Image" width="50">
                                      <a href="#" class="" data-toggle="modal" data-target="#editImagesModal-{{ parent_variant.id }}-{{ image.id }}"><i class="bi bi-pencil-square"></i></a>
                                  {% endfor %}

    
                                  <h3>Child Variants</h3>
                                  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#addChildVariantModal{{ parent_variant.id }}">
                                    Add Child Variant
                                  </button>
                                  <div id="childAccordion{{ parent_variant.id }}">
                                      {% for child_variant in child_variants %}
                                          {% if child_variant.parent_variant == parent_variant %}
                                              <div class="card">
                                                <div id="childHeading{{ child_variant.id }}" class="card-header" data-toggle="collapse" data-target="#childCollapse{{ child_variant.id }}" aria-expanded="true" aria-controls="childCollapse{{ child_variant.id }}">
                                                    <div class="row">
                                                      <div class="col-4">  
                                                    <h2>Size: {{ child_variant.inventory_child.size }} </h2> </div>  
                                                    <div class="col-4"> <h2>Price:  {{ child_variant.price }}</h2> </div>
                                                    <div class="col-4" >  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#editChildVariantModal{{ child_variant.id }}">
                                                        Edit Child Variant
                                                    </button>   </div>
                                                    <!-- Edit Child Variant Modal -->
<div class="modal fade" id="editChildVariantModal{{ child_variant.id }}" tabindex="-1" role="dialog" aria-labelledby="editChildVariantModalLabel{{ child_variant.id }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editChildVariantModalLabel{{ child_variant.id }}">Edit Child Variant</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Edit Child Variant Form -->
                <form action="{% url 'edit_product_child_variant' child_variant.id %}" method="POST">
                    {% csrf_token %}
                    
                    <!-- Fields to edit -->
                    <div class="form-group">
                        <label for="size">Price</label>
                        <input type="text" name="price" class="form-control" value="{{ child_variant.price }}" required>
                    </div>
                   
                    <!-- Add more fields as needed -->
                    
                    <!-- Submit Button -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

                                                       
                                                </div>
                                                </div>
                                                  <div id="childCollapse{{ child_variant.id }}" class="collapse" aria-labelledby="childHeading{{ child_variant.id }}" data-parent="#childAccordion{{ parent_variant.id }}">
                                                      <div class="card-body">
                                                         <h4>Inventory: {{ child_variant.inventory_child.quantity }} Nos</h2>
                                                         <h2>Status: {{ child_variant.inventory_child.status }} </h2>
                                                         
                                                      </div>
                                                  </div>
                                              </div>
                                          {% endif %}
                                      {% endfor %}
                                  </div>
                                  <div class="modal fade" id="addChildVariantModal{{ parent_variant.id }}" tabindex="-1" role="dialog" aria-labelledby="addChildVariantModalLabel{{ parent_variant.id }}" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                      <div class="modal-content">
                                        <div class="modal-header">
                                          <h5 class="modal-title" id="addChildVariantModalLabel{{ parent_variant.id }}">Add Child Variant for {{ parent_variant.inventory_parent.color }}</h5>
                                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                          </button>
                                        </div>
                                        <div class="modal-body">
                                          <!-- Form to add new child variant fields -->
                                          <form method="POST" action="{% url 'add_product_child_variant' %}">
                                            {% csrf_token %}
                                            <!-- Add your form fields here for the child variant -->
                                            <div class="form-group">
                                                <label for="size">Child Variants</label>
                                                <select class="form-control" id="size" name="size" required>
                                                    <option value="" selected disabled>Select Child Variant</option>
                                                    {% for child_variant in parent_variant.inventory_parent.all_child_variants %}
                                                        <option value="{{ child_variant.id }}">{{ child_variant.size }} </option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group">
                                              <label for="price">Price</label>
                                              <input type="number" class="form-control" id="price" name="price" required>
                                            </div>
                                           
                                            <input type="hidden" name="parent_variant_id" value="{{ parent_variant.id }}">
                                  
                                            <div class="modal-footer">
                                              <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                              <button type="submit" class="btn btn-primary">Save changes</button>
                                            </div>
                                          </form>
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                            
                        
                            </div>
                        </div>
                    </div>

                     {% for image in variant.v_images.all %}
                      <div id="editImagesModal-{{ variant.id }}-{{ image.id }}" class="modal fade">
                        <div class="modal-dialog modal-lg" style="max-width: 500px;">
                            <div class="modal-content" style="width: fit-content;">
                                <div class="modal-header">
                                    <h4 class="modal-title">Edit Image</h4>
                                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <!-- Existing image inside the loop -->
                                    <img id="imageCropper{{ variant.id }}-{{ image.id }}" src="{{ image.image.url }}" alt="Image to Crop" style="max-width: 100%;">

                                    <!-- File input for updating image inside the loop -->
                                    <div class="form-group mt-3">
                                        <label for="updateImage{{ variant.id }}-{{ image.id }}">Update Image:</label>
                                        <input type="file" class="form-control-file" id="updateImage{{ variant.id }}-{{ image.id }}" accept="image/*">
                                    </div>

                                    <!-- Cropper container for image inside the loop -->
                                    <div id="cropperContainer{{ variant.id }}-{{ image.id }}" style="max-width: 300px;">
                                        <!-- Cropper canvas for image inside the loop -->
                                        <canvas id="cropperCanvas{{ variant.id }}-{{ image.id }}"></canvas>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-info" id="updateImageBtn{{ variant.id }}-{{ image.id }}">Update Image</button>
                                    <button type="button" class="btn btn-success" id="saveCroppedImage{{ variant.id }}-{{ image.id }}">Save Image</button>
                                </div>
                            </div>
                        </div>
                    </div> 
                    <script>
                        $('#editImagesModal-{{ variant.id }}-{{ image.id }}').on('shown.bs.modal', function () {
                            var cropper = new Cropper(document.getElementById('imageCropper{{ variant.id }}-{{ image.id }}'), {
                                aspectRatio: 1,
                                viewMode: 2,
                            });

                            // Update image on button click
                            $('#updateImageBtn{{ variant.id }}-{{ image.id }}').on('click', function () {
                                var input = document.getElementById('updateImage{{ variant.id }}-{{ image.id }}');
                                var file = input.files[0];

                                if (file) {
                                    var reader = new FileReader();
                                    reader.onload = function (e) {
                                        // Replace the existing image with the new one
                                        $('#imageCropper{{ variant.id }}-{{ image.id }}').attr('src', e.target.result);
                                        cropper.replace(e.target.result);
                                    };
                                    reader.readAsDataURL(file);
                                }
                            });

                            // Save the cropped image on button click
                            $('#saveCroppedImage{{ variant.id }}-{{ image.id }}').on('click', function () {
                                var canvas = cropper.getCroppedCanvas();
                                // Get the data URL of the cropped image in JPEG format
                                var croppedImageData = canvas.toDataURL('image/jpeg');

                                // Make an AJAX request to update the image field
                                $.ajax({
                                    type: "POST",
                                    url: "{% url 'variant_edit_image' variant.id image.id %}",
                                    data: {
                                        image_data: croppedImageData,
                                        csrfmiddlewaretoken: '{{ csrf_token }}'
                                    },
                                    success: function (response) {
                                        // Handle success, if needed
                                        console.log('Image updated successfully');

                                        // Refresh the content of the 'images' div
                                        $('#images').load(window.location + ' #images');

                                        // Close the modal
                                        $('#editImagesModal-{{ variant.id }}-{{ image.id }}').modal('hide');
                                    },
                                    error: function (error) {
                                        // Handle error, if needed
                                        console.error('Error updating image:', error);
                                    }
                                });
                            });

                            // Reset Cropper on modal close
                            $('#editImagesModal-{{ variant.id }}-{{ image.id }}').on('hidden.bs.modal', function () {
                                var cropper = $('#imageCropper{{ variant.id }}-{{ image.id }}').data('cropper');
                                if (cropper) {
                                    cropper.destroy();
                                }
                            });
                        });
                    </script> 
                    {% endfor %}

                {% endfor %}
            </div>
        
        <!-- Add Product Parent Variant Modal -->
<div class="modal fade" id="addParentVariantModal" tabindex="-1" role="dialog" aria-labelledby="addParentVariantModalLabel" aria-hidden="true">
<div class="modal-dialog" role="document">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="addParentVariantModalLabel">Add Parent Variant</h5>
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">&times;</span>
</button>
</div>
<div class="modal-body">
<!-- Parent Variant Form -->
<form id="addParentVariantForm" action="{% url 'add_product_parent_variant' %}" method="POST" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Color Input for ProductParentVariant -->
    <div class="form-group">
        <label for="color">Color</label>
        <input type="color" name="color" class="form-control" required>
    </div>

    <input type="number" name="product_id" value="{{product.id}}" hidden>

    <!-- Dropdown for ProductParentVariantInventory colors -->
    <div class="form-group">
        <label for="inventory_color">Select Color from Inventory</label>
        <select name="parent_inventory_id" class="form-control" required>
            <option value="" selected disabled>Select Color</option>
            {% for inventory_item in product_parent_variant_inventory %}
                <option value="{{ inventory_item.id }}">{{ inventory_item.color }}</option>
            {% endfor %}
        </select>
    </div>

    <!-- Other fields for ProductParentVariant -->
    <div class="form-group">
        <label for="main_image">Main Image</label>
        <input type="file" name="main_image" accept="image/*" class="form-control-file">
    </div>

    <div class="form-group">
        <label for="images">Additional Images</label>
        <input type="file" name="images" accept="image/*" class="form-control-file" multiple>
    </div>
                <div class="form-group">
                    <h6 class="mb-2 pb-1">Status: </h6>

            <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptionsDefault" 
            value="True" checked />
            <label class="form-check-label" for="active">True</label>
            </div>


            <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="inlineRadioOptionsDefault"
            value="False" />
            <label class="form-check-label" for="inactive">False</label>
            </div>
                </div>

    <!-- Add more fields as needed -->

    <!-- Submit Button -->
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Add Parent Variant</button>
    </div>
</form>
</div>
</div>
</div>
</div>
{% for i in parent_variants %}
<div id="editImagesModal-{{i.id}}" class="modal fade">
    <div class="modal-dialog modal-lg" style="max-width: 500px;">
        <div class="modal-content" style="width: fit-content;">
            <div class="modal-header">
                <h4 class="modal-title">Edit Images</h4>
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Existing image -->
                <img id="imageCropper{{i.id}}" src="{{i.main_image.url}}" alt="Image to Crop" style="max-width: 100%;">

                <!-- File input for updating image -->
                <div class="form-group mt-3">
                    <label for="updateImage{{i.id}}">Update Image:</label>
                    <input type="file" class="form-control-file" id="updateImage{{i.id}}" accept="image/*">
                </div>

                <!-- Cropper container with max-width and max-height -->
                <div id="cropperContainer{{i.id}}" style="max-width: 300px;"  >
                    <!-- Cropper canvas -->
                    <canvas id="cropperCanvas{{i.id}}" ></canvas>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-info" id="updateImageBtn{{i.id}}">Update Image</button>
                <button type="button" class="btn btn-success" id="saveCroppedImage{{i.id}}">Save Images</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Initialize Cropper on modal shown
   
    $('#editImagesModal-{{i.id}}').on('shown.bs.modal', function () {
        
           
            var cropper = new Cropper(document.getElementById('imageCropper{{i.id}}'), {
                aspectRatio: 1,
                viewMode: 2,
            });
       
       

        // Update image on button click
        $('#updateImageBtn{{i.id}}').on('click', function () {
            var input = document.getElementById('updateImage{{i.id}}');
            var file = input.files[0];

            if (file) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    // Replace the existing image with the new one
                    $('#imageCropper{{i.id}}').attr('src', e.target.result);
                    cropper.replace(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        });

        // Save the cropped image on button click
        $('#saveCroppedImage{{i.id}}').on('click', function () {
            var canvas = cropper.getCroppedCanvas();
            // Get the data URL of the cropped image in JPEG format
            var croppedImageData = canvas.toDataURL('image/jpeg');

            // Make an AJAX request to update the main_image field
            $.ajax({
                type: "POST",
                url: "{% url 'edit_main_image' i.id %}",
                data: {
                    image_data: croppedImageData,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function (response) {
                    // Handle success, if needed
                    console.log('Image updated successfully');

                    // Refresh the content of the 'images' div
                    $('#images').load(window.location + ' #images');

                    // Close the modal
                    $('#editImagesModal-{{i.id}}').modal('hide');
                },
                error: function (error) {
                    // Handle error, if needed
                    console.error('Error updating image:', error);
                }
            });
        });

        // Reset Cropper on modal close
        $('#editImagesModal-{{i.id}}').on('hidden.bs.modal', function () {
            var cropper = $('#imageCropper{{i.id}}').data('cropper');
            if (cropper) {
                cropper.destroy();
            }
        });
    });
</script>

{% for image in i.images.all %}
<div id="editImagesModal-{{ i.id }}-{{ image.id }}" class="modal fade">
  <div class="modal-dialog modal-lg" style="max-width: 500px;">
      <div class="modal-content" style="width: fit-content;">
          <div class="modal-header">
              <h4 class="modal-title">Edit Image</h4>
              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
          </div>
          <div class="modal-body">
              <!-- Existing image inside the loop -->
              <img id="imageCropper{{ i.id }}-{{ image.id }}" src="{{ image.image.url }}" alt="Image to Crop" style="max-width: 100%;">

              <!-- File input for updating image inside the loop -->
              <div class="form-group mt-3">
                  <label for="updateImage{{ i.id }}-{{ image.id }}">Update Image:</label>
                  <input type="file" class="form-control-file" id="updateImage{{ i.id }}-{{ image.id }}" accept="image/*">
              </div>

              <!-- Cropper container for image inside the loop -->
              <div id="cropperContainer{{ i.id }}-{{ image.id }}" style="max-width: 300px;">
                  <!-- Cropper canvas for image inside the loop -->
                  <canvas id="cropperCanvas{{ i.id }}-{{ image.id }}"></canvas>
              </div>
          </div>
          <div class="modal-footer">
              <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-info" id="updateImageBtn{{ i.id }}-{{ image.id }}">Update Image</button>
              <button type="button" class="btn btn-success" id="saveCroppedImage{{ i.id }}-{{ image.id }}">Save Image</button>
          </div>
      </div>
  </div>
</div> 
<script>
  $('#editImagesModal-{{ i.id }}-{{ image.id }}').on('shown.bs.modal', function () {
      var cropper = new Cropper(document.getElementById('imageCropper{{ i.id }}-{{ image.id }}'), {
          aspectRatio: 1,
          viewMode: 2,
      });

      // Update image on button click
      $('#updateImageBtn{{ i.id }}-{{ image.id }}').on('click', function () {
          var input = document.getElementById('updateImage{{ i.id }}-{{ image.id }}');
          var file = input.files[0];

          if (file) {
              var reader = new FileReader();
              reader.onload = function (e) {
                  // Replace the existing image with the new one
                  $('#imageCropper{{ i.id }}-{{ image.id }}').attr('src', e.target.result);
                  cropper.replace(e.target.result);
              };
              reader.readAsDataURL(file);
          }
      });

      // Save the cropped image on button click
      $('#saveCroppedImage{{ i.id }}-{{ image.id }}').on('click', function () {
          var canvas = cropper.getCroppedCanvas();
          // Get the data URL of the cropped image in JPEG format
          var croppedImageData = canvas.toDataURL('image/jpeg');

          // Make an AJAX request to update the image field
          $.ajax({
              type: "POST",
              url: "{% url 'variant_edit_image' i.id image.id %}",
              data: {
                  image_data: croppedImageData,
                  csrfmiddlewaretoken: '{{ csrf_token }}'
              },
              success: function (response) {
                  // Handle success, if needed
                  console.log('Image updated successfully');

                  // Refresh the content of the 'images' div
                  $('#images').load(window.location + ' #images');

                  // Close the modal
                  $('#editImagesModal-{{ i.id }}-{{ image.id }}').modal('hide');
              },
              error: function (error) {
                  // Handle error, if needed
                  console.error('Error updating image:', error);
              }
          });
      });

      // Reset Cropper on modal close
      $('#editImagesModal-{{ i.id }}-{{ image.id }}').on('hidden.bs.modal', function () {
          var cropper = $('#imageCropper{{ i.id }}-{{ image.id }}').data('cropper');
          if (cropper) {
              cropper.destroy();
          }
      });
  });
</script> 
{% endfor %}
{% endfor %}






  </section>

  </main><!-- End #main -->
  
{% endblock %}